#!/usr/bin/env python3
"""
SME Network Security Assessment Framework
Week 6: Vulnerability Comparison Script

This script compares vulnerability scan results to:
- Track remediation progress
- Measure security improvements
- Generate comparison reports
- Identify new and resolved vulnerabilities

Author: SME Security Team
Version: 1.0.0
"""

import json
import logging
import argparse
import xml.etree.ElementTree as ET
from datetime import datetime
from pathlib import Path
from dataclasses import dataclass, field, asdict
from typing import List, Dict, Optional, Set, Tuple
from collections import Counter
import hashlib

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('vulnerability_comparison.log'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)


@dataclass
class Vulnerability:
    """Represents a single vulnerability"""
    vuln_id: str
    name: str
    severity: str  # critical, high, medium, low, info
    cvss_score: float
    host: str
    port: Optional[int]
    protocol: str
    description: str
    solution: str
    cve_ids: List[str] = field(default_factory=list)
    plugin_id: Optional[str] = None
    first_seen: Optional[str] = None
    last_seen: Optional[str] = None

    def unique_key(self) -> str:
        """Generate unique identifier for this vulnerability"""
        key_string = f"{self.name}|{self.host}|{self.port}|{self.protocol}"
        return hashlib.md5(key_string.encode()).hexdigest()


@dataclass
class ScanResult:
    """Represents a complete scan result"""
    scan_id: str
    scan_date: str
    scanner: str
    total_hosts: int
    vulnerabilities: List[Vulnerability] = field(default_factory=list)

    def get_vuln_by_severity(self) -> Dict[str, int]:
        """Count vulnerabilities by severity"""
        counter = Counter(v.severity.lower() for v in self.vulnerabilities)
        return {
            'critical': counter.get('critical', 0),
            'high': counter.get('high', 0),
            'medium': counter.get('medium', 0),
            'low': counter.get('low', 0),
            'info': counter.get('info', 0) + counter.get('informational', 0)
        }

    def get_vuln_by_host(self) -> Dict[str, int]:
        """Count vulnerabilities by host"""
        return dict(Counter(v.host for v in self.vulnerabilities))


@dataclass
class ComparisonResult:
    """Results of comparing two scans"""
    baseline_scan: str
    current_scan: str
    baseline_date: str
    current_date: str

    # Vulnerability changes
    new_vulnerabilities: List[Vulnerability] = field(default_factory=list)
    resolved_vulnerabilities: List[Vulnerability] = field(default_factory=list)
    unchanged_vulnerabilities: List[Vulnerability] = field(default_factory=list)

    # Summary metrics
    baseline_total: int = 0
    current_total: int = 0
    new_count: int = 0
    resolved_count: int = 0

    # By severity
    baseline_by_severity: Dict[str, int] = field(default_factory=dict)
    current_by_severity: Dict[str, int] = field(default_factory=dict)
    change_by_severity: Dict[str, int] = field(default_factory=dict)

    # Improvement metrics
    improvement_percentage: float = 0.0
    risk_score_baseline: float = 0.0
    risk_score_current: float = 0.0
    risk_reduction: float = 0.0


class VulnerabilityScanParser:
    """Parses vulnerability scan results from various formats"""

    def parse_file(self, filepath: str) -> ScanResult:
        """Parse scan results from file"""
        path = Path(filepath)

        if not path.exists():
            raise FileNotFoundError(f"Scan file not found: {filepath}")

        suffix = path.suffix.lower()

        if suffix == '.json':
            return self._parse_json(path)
        elif suffix == '.xml':
            return self._parse_nmap_xml(path)
        elif suffix == '.nessus':
            return self._parse_nessus(path)
        else:
            # Try JSON first, then XML
            try:
                return self._parse_json(path)
            except:
                return self._parse_nmap_xml(path)

    def _parse_json(self, path: Path) -> ScanResult:
        """Parse JSON scan results"""
        with open(path, 'r') as f:
            data = json.load(f)

        # Handle different JSON formats
        if 'scan_results' in data:
            # Our framework format
            return self._parse_framework_json(data)
        elif 'vulnerabilities' in data:
            # Generic vulnerability list
            return self._parse_generic_json(data)
        elif 'findings' in data:
            # Findings format
            return self._parse_findings_json(data)
        else:
            raise ValueError("Unknown JSON format")

    def _parse_framework_json(self, data: Dict) -> ScanResult:
        """Parse our framework's JSON format"""
        vulnerabilities = []

        for result in data.get('scan_results', []):
            for vuln_data in result.get('vulnerabilities', []):
                vuln = Vulnerability(
                    vuln_id=vuln_data.get('id', ''),
                    name=vuln_data.get('title', vuln_data.get('name', 'Unknown')),
                    severity=vuln_data.get('severity', 'medium'),
                    cvss_score=float(vuln_data.get('cvss_score', 0) or 0),
                    host=vuln_data.get('affected_host', result.get('target', '')),
                    port=vuln_data.get('affected_port'),
                    protocol=vuln_data.get('protocol', 'tcp'),
                    description=vuln_data.get('description', ''),
                    solution=vuln_data.get('remediation', ''),
                    cve_ids=vuln_data.get('cve_ids', [])
                )
                vulnerabilities.append(vuln)

        return ScanResult(
            scan_id=data.get('report_metadata', {}).get('id', 'unknown'),
            scan_date=data.get('report_metadata', {}).get('generated', datetime.now().isoformat()),
            scanner=data.get('report_metadata', {}).get('scanner', 'SME Framework'),
            total_hosts=len(data.get('scan_results', [])),
            vulnerabilities=vulnerabilities
        )

    def _parse_generic_json(self, data: Dict) -> ScanResult:
        """Parse generic vulnerability JSON"""
        vulnerabilities = []

        for vuln_data in data.get('vulnerabilities', []):
            vuln = Vulnerability(
                vuln_id=vuln_data.get('id', str(len(vulnerabilities))),
                name=vuln_data.get('name', vuln_data.get('title', 'Unknown')),
                severity=vuln_data.get('severity', 'medium'),
                cvss_score=float(vuln_data.get('cvss', vuln_data.get('cvss_score', 0)) or 0),
                host=vuln_data.get('host', vuln_data.get('ip', 'unknown')),
                port=vuln_data.get('port'),
                protocol=vuln_data.get('protocol', 'tcp'),
                description=vuln_data.get('description', ''),
                solution=vuln_data.get('solution', vuln_data.get('remediation', '')),
                cve_ids=vuln_data.get('cves', vuln_data.get('cve_ids', []))
            )
            vulnerabilities.append(vuln)

        return ScanResult(
            scan_id=data.get('scan_id', 'unknown'),
            scan_date=data.get('scan_date', datetime.now().isoformat()),
            scanner=data.get('scanner', 'Unknown'),
            total_hosts=len(set(v.host for v in vulnerabilities)),
            vulnerabilities=vulnerabilities
        )

    def _parse_findings_json(self, data: Dict) -> ScanResult:
        """Parse findings-based JSON format"""
        vulnerabilities = []

        for finding in data.get('findings', []):
            vuln = Vulnerability(
                vuln_id=finding.get('id', ''),
                name=finding.get('title', 'Unknown'),
                severity=finding.get('severity', 'medium'),
                cvss_score=float(finding.get('cvss_score', 0) or 0),
                host=finding.get('affected_host', ''),
                port=finding.get('affected_port'),
                protocol='tcp',
                description=finding.get('description', ''),
                solution=finding.get('remediation', ''),
                cve_ids=finding.get('cve_ids', [])
            )
            vulnerabilities.append(vuln)

        return ScanResult(
            scan_id='findings_scan',
            scan_date=data.get('generated', datetime.now().isoformat()),
            scanner='SME Framework',
            total_hosts=len(set(v.host for v in vulnerabilities)),
            vulnerabilities=vulnerabilities
        )

    def _parse_nmap_xml(self, path: Path) -> ScanResult:
        """Parse Nmap XML output"""
        vulnerabilities = []

        try:
            tree = ET.parse(path)
            root = tree.getroot()

            for host in root.findall('.//host'):
                host_addr = ''
                addr_elem = host.find('.//address[@addrtype="ipv4"]')
                if addr_elem is not None:
                    host_addr = addr_elem.get('addr', '')

                for port in host.findall('.//port'):
                    port_id = int(port.get('portid', 0))
                    protocol = port.get('protocol', 'tcp')

                    for script in port.findall('.//script'):
                        script_id = script.get('id', '')
                        output = script.get('output', '')

                        # Look for vulnerability indicators
                        if 'vuln' in script_id.lower() or 'VULNERABLE' in output:
                            severity = self._determine_severity(output)
                            cves = self._extract_cves(output)

                            vuln = Vulnerability(
                                vuln_id=script_id,
                                name=script_id,
                                severity=severity,
                                cvss_score=self._severity_to_cvss(severity),
                                host=host_addr,
                                port=port_id,
                                protocol=protocol,
                                description=output[:500],
                                solution="Refer to CVE remediation guidance",
                                cve_ids=cves
                            )
                            vulnerabilities.append(vuln)

        except ET.ParseError as e:
            logger.error(f"Error parsing Nmap XML: {e}")

        return ScanResult(
            scan_id='nmap_scan',
            scan_date=datetime.now().isoformat(),
            scanner='Nmap',
            total_hosts=len(set(v.host for v in vulnerabilities)),
            vulnerabilities=vulnerabilities
        )

    def _parse_nessus(self, path: Path) -> ScanResult:
        """Parse Nessus .nessus file"""
        vulnerabilities = []

        try:
            tree = ET.parse(path)
            root = tree.getroot()

            for report_host in root.findall('.//ReportHost'):
                host_name = report_host.get('name', '')

                for item in report_host.findall('.//ReportItem'):
                    plugin_id = item.get('pluginID', '')
                    severity = int(item.get('severity', 0))
                    port = int(item.get('port', 0))
                    protocol = item.get('protocol', 'tcp')

                    # Map Nessus severity (0-4) to our scale
                    severity_map = {0: 'info', 1: 'low', 2: 'medium', 3: 'high', 4: 'critical'}
                    severity_str = severity_map.get(severity, 'medium')

                    plugin_name = item.findtext('plugin_name', 'Unknown')
                    description = item.findtext('description', '')
                    solution = item.findtext('solution', '')
                    cvss = float(item.findtext('cvss_base_score', 0) or 0)

                    # Extract CVEs
                    cves = []
                    for cve_elem in item.findall('.//cve'):
                        cves.append(cve_elem.text)

                    vuln = Vulnerability(
                        vuln_id=plugin_id,
                        name=plugin_name,
                        severity=severity_str,
                        cvss_score=cvss,
                        host=host_name,
                        port=port if port > 0 else None,
                        protocol=protocol,
                        description=description[:1000],
                        solution=solution,
                        cve_ids=cves,
                        plugin_id=plugin_id
                    )
                    vulnerabilities.append(vuln)

        except ET.ParseError as e:
            logger.error(f"Error parsing Nessus file: {e}")

        return ScanResult(
            scan_id='nessus_scan',
            scan_date=datetime.now().isoformat(),
            scanner='Nessus',
            total_hosts=len(set(v.host for v in vulnerabilities)),
            vulnerabilities=vulnerabilities
        )

    def _determine_severity(self, output: str) -> str:
        """Determine severity from script output"""
        output_lower = output.lower()
        if 'critical' in output_lower:
            return 'critical'
        elif 'high' in output_lower:
            return 'high'
        elif 'medium' in output_lower:
            return 'medium'
        elif 'low' in output_lower:
            return 'low'
        return 'medium'

    def _severity_to_cvss(self, severity: str) -> float:
        """Convert severity to approximate CVSS score"""
        mapping = {
            'critical': 9.5,
            'high': 7.5,
            'medium': 5.0,
            'low': 2.5,
            'info': 0.0
        }
        return mapping.get(severity.lower(), 5.0)

    def _extract_cves(self, text: str) -> List[str]:
        """Extract CVE IDs from text"""
        import re
        return re.findall(r'CVE-\d{4}-\d+', text, re.IGNORECASE)


class VulnerabilityComparator:
    """Compares vulnerability scan results"""

    def __init__(self):
        self.severity_weights = {
            'critical': 10,
            'high': 5,
            'medium': 2,
            'low': 1,
            'info': 0.1
        }

    def compare(self, baseline: ScanResult, current: ScanResult) -> ComparisonResult:
        """Compare two scan results"""
        logger.info(f"Comparing scans: {baseline.scan_id} vs {current.scan_id}")

        # Create vulnerability indexes
        baseline_vulns = {v.unique_key(): v for v in baseline.vulnerabilities}
        current_vulns = {v.unique_key(): v for v in current.vulnerabilities}

        baseline_keys = set(baseline_vulns.keys())
        current_keys = set(current_vulns.keys())

        # Identify changes
        new_keys = current_keys - baseline_keys
        resolved_keys = baseline_keys - current_keys
        unchanged_keys = baseline_keys & current_keys

        # Build result
        result = ComparisonResult(
            baseline_scan=baseline.scan_id,
            current_scan=current.scan_id,
            baseline_date=baseline.scan_date,
            current_date=current.scan_date,
            new_vulnerabilities=[current_vulns[k] for k in new_keys],
            resolved_vulnerabilities=[baseline_vulns[k] for k in resolved_keys],
            unchanged_vulnerabilities=[current_vulns[k] for k in unchanged_keys],
            baseline_total=len(baseline.vulnerabilities),
            current_total=len(current.vulnerabilities),
            new_count=len(new_keys),
            resolved_count=len(resolved_keys),
            baseline_by_severity=baseline.get_vuln_by_severity(),
            current_by_severity=current.get_vuln_by_severity()
        )

        # Calculate severity changes
        result.change_by_severity = {
            severity: result.current_by_severity.get(severity, 0) - result.baseline_by_severity.get(severity, 0)
            for severity in ['critical', 'high', 'medium', 'low', 'info']
        }

        # Calculate improvement metrics
        result.risk_score_baseline = self._calculate_risk_score(baseline.vulnerabilities)
        result.risk_score_current = self._calculate_risk_score(current.vulnerabilities)
        result.risk_reduction = result.risk_score_baseline - result.risk_score_current

        if result.baseline_total > 0:
            result.improvement_percentage = (
                (result.baseline_total - result.current_total) / result.baseline_total * 100
            )

        logger.info(f"Comparison complete: {result.new_count} new, {result.resolved_count} resolved")

        return result

    def _calculate_risk_score(self, vulnerabilities: List[Vulnerability]) -> float:
        """Calculate weighted risk score"""
        score = 0.0
        for vuln in vulnerabilities:
            weight = self.severity_weights.get(vuln.severity.lower(), 1)
            cvss_factor = vuln.cvss_score / 10 if vuln.cvss_score > 0 else 0.5
            score += weight * cvss_factor
        return round(score, 2)


class ComparisonReportGenerator:
    """Generates comparison reports"""

    def __init__(self, output_dir: str = "reports"):
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(parents=True, exist_ok=True)

    def generate_report(self, comparison: ComparisonResult) -> Dict[str, str]:
        """Generate comparison reports"""
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        reports = {}

        # JSON report
        json_path = self.output_dir / f"vuln_comparison_{timestamp}.json"
        self._save_json_report(comparison, json_path)
        reports['json'] = str(json_path)

        # HTML report
        html_path = self.output_dir / f"vuln_comparison_{timestamp}.html"
        self._save_html_report(comparison, html_path)
        reports['html'] = str(html_path)

        # Text summary
        txt_path = self.output_dir / f"vuln_comparison_summary_{timestamp}.txt"
        self._save_text_summary(comparison, txt_path)
        reports['summary'] = str(txt_path)

        return reports

    def _save_json_report(self, comparison: ComparisonResult, path: Path):
        """Save JSON comparison report"""
        report = {
            'metadata': {
                'generated': datetime.now().isoformat(),
                'baseline_scan': comparison.baseline_scan,
                'baseline_date': comparison.baseline_date,
                'current_scan': comparison.current_scan,
                'current_date': comparison.current_date
            },
            'summary': {
                'baseline_total': comparison.baseline_total,
                'current_total': comparison.current_total,
                'new_vulnerabilities': comparison.new_count,
                'resolved_vulnerabilities': comparison.resolved_count,
                'improvement_percentage': round(comparison.improvement_percentage, 1),
                'risk_score_baseline': comparison.risk_score_baseline,
                'risk_score_current': comparison.risk_score_current,
                'risk_reduction': comparison.risk_reduction
            },
            'severity_comparison': {
                'baseline': comparison.baseline_by_severity,
                'current': comparison.current_by_severity,
                'change': comparison.change_by_severity
            },
            'new_vulnerabilities': [asdict(v) for v in comparison.new_vulnerabilities],
            'resolved_vulnerabilities': [asdict(v) for v in comparison.resolved_vulnerabilities]
        }

        with open(path, 'w') as f:
            json.dump(report, f, indent=2, default=str)

    def _save_html_report(self, comparison: ComparisonResult, path: Path):
        """Save HTML comparison report"""
        # Determine trend indicators
        def trend_arrow(change):
            if change < 0:
                return '<span style="color: green;">&#9660;</span>'  # Down arrow (good)
            elif change > 0:
                return '<span style="color: red;">&#9650;</span>'  # Up arrow (bad)
            return '<span style="color: gray;">&#9644;</span>'  # No change

        html = f'''<!DOCTYPE html>
<html>
<head>
    <title>Vulnerability Comparison Report</title>
    <style>
        body {{ font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; background: #f5f5f5; }}
        .container {{ max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }}
        h1 {{ color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }}
        h2 {{ color: #34495e; margin-top: 30px; }}
        .summary-grid {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }}
        .card {{ background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; }}
        .card.improvement {{ background: #d4edda; }}
        .card.decline {{ background: #f8d7da; }}
        .card h3 {{ margin: 0; font-size: 2.5em; color: #2c3e50; }}
        .card p {{ margin: 10px 0 0 0; color: #666; }}
        .comparison-table {{ width: 100%; border-collapse: collapse; margin: 20px 0; }}
        .comparison-table th, .comparison-table td {{ padding: 12px; border: 1px solid #ddd; text-align: center; }}
        .comparison-table th {{ background: #3498db; color: white; }}
        .comparison-table tr:nth-child(even) {{ background: #f8f9fa; }}
        .severity-critical {{ color: #dc3545; font-weight: bold; }}
        .severity-high {{ color: #fd7e14; font-weight: bold; }}
        .severity-medium {{ color: #ffc107; }}
        .severity-low {{ color: #17a2b8; }}
        .vuln-list {{ max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 15px; }}
        .vuln-item {{ padding: 10px; border-bottom: 1px solid #eee; }}
        .vuln-item:last-child {{ border-bottom: none; }}
        .badge {{ display: inline-block; padding: 3px 8px; border-radius: 4px; color: white; font-size: 0.8em; }}
        .badge-critical {{ background: #dc3545; }}
        .badge-high {{ background: #fd7e14; }}
        .badge-medium {{ background: #ffc107; color: #333; }}
        .badge-low {{ background: #17a2b8; }}
        .badge-new {{ background: #dc3545; }}
        .badge-resolved {{ background: #28a745; }}
        .improvement-banner {{ background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 20px; border-radius: 8px; text-align: center; margin: 20px 0; }}
        .decline-banner {{ background: linear-gradient(135deg, #dc3545, #fd7e14); color: white; padding: 20px; border-radius: 8px; text-align: center; margin: 20px 0; }}
    </style>
</head>
<body>
<div class="container">
    <h1>Vulnerability Comparison Report</h1>
    <p><strong>Baseline:</strong> {comparison.baseline_scan} ({comparison.baseline_date})</p>
    <p><strong>Current:</strong> {comparison.current_scan} ({comparison.current_date})</p>

    {'<div class="improvement-banner"><h2>Security Improved!</h2><p>Vulnerability count reduced by ' + str(abs(round(comparison.improvement_percentage, 1))) + '%</p></div>' if comparison.improvement_percentage > 0 else ''}
    {'<div class="decline-banner"><h2>Attention Required</h2><p>Vulnerability count increased by ' + str(abs(round(comparison.improvement_percentage, 1))) + '%</p></div>' if comparison.improvement_percentage < 0 else ''}

    <h2>Summary</h2>
    <div class="summary-grid">
        <div class="card {'improvement' if comparison.improvement_percentage > 0 else 'decline' if comparison.improvement_percentage < 0 else ''}">
            <h3>{comparison.improvement_percentage:+.1f}%</h3>
            <p>Overall Change</p>
        </div>
        <div class="card">
            <h3>{comparison.baseline_total} &#8594; {comparison.current_total}</h3>
            <p>Total Vulnerabilities</p>
        </div>
        <div class="card" style="background: #d4edda;">
            <h3>{comparison.resolved_count}</h3>
            <p>Resolved</p>
        </div>
        <div class="card" style="background: #f8d7da;">
            <h3>{comparison.new_count}</h3>
            <p>New</p>
        </div>
        <div class="card">
            <h3>{comparison.risk_score_baseline:.1f} &#8594; {comparison.risk_score_current:.1f}</h3>
            <p>Risk Score</p>
        </div>
        <div class="card {'improvement' if comparison.risk_reduction > 0 else 'decline' if comparison.risk_reduction < 0 else ''}">
            <h3>{comparison.risk_reduction:+.1f}</h3>
            <p>Risk Reduction</p>
        </div>
    </div>

    <h2>Severity Comparison</h2>
    <table class="comparison-table">
        <tr>
            <th>Severity</th>
            <th>Baseline</th>
            <th>Current</th>
            <th>Change</th>
            <th>Trend</th>
        </tr>
'''

        for severity in ['critical', 'high', 'medium', 'low', 'info']:
            baseline = comparison.baseline_by_severity.get(severity, 0)
            current = comparison.current_by_severity.get(severity, 0)
            change = comparison.change_by_severity.get(severity, 0)
            html += f'''
        <tr>
            <td class="severity-{severity}">{severity.capitalize()}</td>
            <td>{baseline}</td>
            <td>{current}</td>
            <td>{change:+d}</td>
            <td>{trend_arrow(change)}</td>
        </tr>
'''

        html += '''
    </table>

    <h2>New Vulnerabilities</h2>
'''

        if comparison.new_vulnerabilities:
            html += '<div class="vuln-list">\n'
            for vuln in sorted(comparison.new_vulnerabilities,
                              key=lambda v: ['critical', 'high', 'medium', 'low', 'info'].index(v.severity.lower())):
                html += f'''
        <div class="vuln-item">
            <span class="badge badge-new">NEW</span>
            <span class="badge badge-{vuln.severity.lower()}">{vuln.severity.upper()}</span>
            <strong>{vuln.name}</strong>
            <br><small>Host: {vuln.host}:{vuln.port or 'N/A'} | CVSS: {vuln.cvss_score}</small>
            {f'<br><small>CVEs: {", ".join(vuln.cve_ids)}</small>' if vuln.cve_ids else ''}
        </div>
'''
            html += '</div>\n'
        else:
            html += '<p>No new vulnerabilities detected.</p>\n'

        html += '''
    <h2>Resolved Vulnerabilities</h2>
'''

        if comparison.resolved_vulnerabilities:
            html += '<div class="vuln-list">\n'
            for vuln in sorted(comparison.resolved_vulnerabilities,
                              key=lambda v: ['critical', 'high', 'medium', 'low', 'info'].index(v.severity.lower())):
                html += f'''
        <div class="vuln-item">
            <span class="badge badge-resolved">RESOLVED</span>
            <span class="badge badge-{vuln.severity.lower()}">{vuln.severity.upper()}</span>
            <strong>{vuln.name}</strong>
            <br><small>Host: {vuln.host}:{vuln.port or 'N/A'} | CVSS: {vuln.cvss_score}</small>
        </div>
'''
            html += '</div>\n'
        else:
            html += '<p>No vulnerabilities were resolved between scans.</p>\n'

        html += f'''
    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #666;">
        <p>Generated: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}</p>
        <p>SME Network Security Assessment Framework</p>
    </div>
</div>
</body>
</html>
'''

        with open(path, 'w') as f:
            f.write(html)

    def _save_text_summary(self, comparison: ComparisonResult, path: Path):
        """Save text summary"""
        summary = f'''
================================================================================
                    VULNERABILITY COMPARISON SUMMARY
================================================================================

Baseline Scan: {comparison.baseline_scan}
Baseline Date: {comparison.baseline_date}
Current Scan:  {comparison.current_scan}
Current Date:  {comparison.current_date}

OVERALL CHANGE
--------------
Baseline Total:      {comparison.baseline_total:>6}
Current Total:       {comparison.current_total:>6}
                     ------
Net Change:          {comparison.current_total - comparison.baseline_total:>+6}
Improvement:         {comparison.improvement_percentage:>+5.1f}%

RISK SCORE
----------
Baseline Risk Score: {comparison.risk_score_baseline:>8.1f}
Current Risk Score:  {comparison.risk_score_current:>8.1f}
Risk Reduction:      {comparison.risk_reduction:>+8.1f}

SEVERITY BREAKDOWN
------------------
               Baseline    Current     Change
Critical:      {comparison.baseline_by_severity.get('critical', 0):>8}    {comparison.current_by_severity.get('critical', 0):>8}    {comparison.change_by_severity.get('critical', 0):>+6}
High:          {comparison.baseline_by_severity.get('high', 0):>8}    {comparison.current_by_severity.get('high', 0):>8}    {comparison.change_by_severity.get('high', 0):>+6}
Medium:        {comparison.baseline_by_severity.get('medium', 0):>8}    {comparison.current_by_severity.get('medium', 0):>8}    {comparison.change_by_severity.get('medium', 0):>+6}
Low:           {comparison.baseline_by_severity.get('low', 0):>8}    {comparison.current_by_severity.get('low', 0):>8}    {comparison.change_by_severity.get('low', 0):>+6}
Info:          {comparison.baseline_by_severity.get('info', 0):>8}    {comparison.current_by_severity.get('info', 0):>8}    {comparison.change_by_severity.get('info', 0):>+6}

CHANGES
-------
New Vulnerabilities:      {comparison.new_count}
Resolved Vulnerabilities: {comparison.resolved_count}

'''

        if comparison.new_vulnerabilities:
            summary += "NEW VULNERABILITIES REQUIRING ATTENTION:\n"
            for i, vuln in enumerate(sorted(comparison.new_vulnerabilities,
                                          key=lambda v: ['critical', 'high', 'medium', 'low', 'info'].index(v.severity.lower()))[:10], 1):
                summary += f"  {i}. [{vuln.severity.upper()}] {vuln.name}\n"
                summary += f"     Host: {vuln.host}:{vuln.port or 'N/A'}\n"

        if comparison.resolved_vulnerabilities:
            summary += "\nRESOLVED VULNERABILITIES:\n"
            for i, vuln in enumerate(sorted(comparison.resolved_vulnerabilities,
                                          key=lambda v: ['critical', 'high', 'medium', 'low', 'info'].index(v.severity.lower()))[:10], 1):
                summary += f"  {i}. [{vuln.severity.upper()}] {vuln.name}\n"

        summary += '''

================================================================================
'''

        with open(path, 'w') as f:
            f.write(summary)


def generate_sample_data(output_dir: str = "sample_data"):
    """Generate sample scan data for testing"""
    output_path = Path(output_dir)
    output_path.mkdir(parents=True, exist_ok=True)

    # Sample baseline scan (more vulnerabilities)
    baseline = {
        "scan_id": "baseline_scan_001",
        "scan_date": "2024-01-01T10:00:00",
        "scanner": "SME Framework",
        "vulnerabilities": [
            {"id": "vuln_001", "name": "SSL/TLS Weak Cipher", "severity": "high", "cvss_score": 7.5,
             "host": "192.168.1.10", "port": 443, "description": "Weak cipher suites enabled",
             "solution": "Disable weak ciphers", "cve_ids": []},
            {"id": "vuln_002", "name": "SSH Root Login Enabled", "severity": "critical", "cvss_score": 9.0,
             "host": "192.168.1.10", "port": 22, "description": "Root login via SSH is enabled",
             "solution": "Disable SSH root login", "cve_ids": []},
            {"id": "vuln_003", "name": "Missing Security Headers", "severity": "medium", "cvss_score": 5.0,
             "host": "192.168.1.20", "port": 80, "description": "HTTP security headers missing",
             "solution": "Add security headers", "cve_ids": []},
            {"id": "vuln_004", "name": "Outdated OpenSSH", "severity": "high", "cvss_score": 7.8,
             "host": "192.168.1.10", "port": 22, "description": "OpenSSH version is outdated",
             "solution": "Update OpenSSH", "cve_ids": ["CVE-2023-1234"]},
            {"id": "vuln_005", "name": "Anonymous FTP", "severity": "high", "cvss_score": 7.0,
             "host": "192.168.1.30", "port": 21, "description": "Anonymous FTP access enabled",
             "solution": "Disable anonymous FTP", "cve_ids": []},
            {"id": "vuln_006", "name": "Default Credentials", "severity": "critical", "cvss_score": 9.5,
             "host": "192.168.1.40", "port": 8080, "description": "Default admin credentials",
             "solution": "Change default credentials", "cve_ids": []},
            {"id": "vuln_007", "name": "Directory Listing", "severity": "low", "cvss_score": 3.0,
             "host": "192.168.1.20", "port": 80, "description": "Directory listing enabled",
             "solution": "Disable directory listing", "cve_ids": []},
        ]
    }

    # Sample current scan (fewer vulnerabilities - some fixed)
    current = {
        "scan_id": "current_scan_001",
        "scan_date": "2024-01-15T10:00:00",
        "scanner": "SME Framework",
        "vulnerabilities": [
            {"id": "vuln_001", "name": "SSL/TLS Weak Cipher", "severity": "high", "cvss_score": 7.5,
             "host": "192.168.1.10", "port": 443, "description": "Weak cipher suites enabled",
             "solution": "Disable weak ciphers", "cve_ids": []},
            # SSH Root Login - FIXED (not in current)
            {"id": "vuln_003", "name": "Missing Security Headers", "severity": "medium", "cvss_score": 5.0,
             "host": "192.168.1.20", "port": 80, "description": "HTTP security headers missing",
             "solution": "Add security headers", "cve_ids": []},
            # Outdated OpenSSH - FIXED
            # Anonymous FTP - FIXED
            # Default Credentials - FIXED
            # Directory Listing - FIXED
            # New vulnerability found
            {"id": "vuln_008", "name": "SQL Injection", "severity": "critical", "cvss_score": 9.8,
             "host": "192.168.1.50", "port": 3306, "description": "SQL injection vulnerability",
             "solution": "Use parameterized queries", "cve_ids": ["CVE-2024-0001"]},
        ]
    }

    # Save sample files
    with open(output_path / "baseline_scan.json", 'w') as f:
        json.dump(baseline, f, indent=2)

    with open(output_path / "current_scan.json", 'w') as f:
        json.dump(current, f, indent=2)

    logger.info(f"Sample data generated in {output_path}")
    return str(output_path / "baseline_scan.json"), str(output_path / "current_scan.json")


def main():
    """Main entry point"""
    parser = argparse.ArgumentParser(
        description='SME Network Security Assessment - Vulnerability Comparison'
    )
    parser.add_argument(
        '-b', '--baseline',
        help='Path to baseline scan results'
    )
    parser.add_argument(
        '-c', '--current',
        help='Path to current scan results'
    )
    parser.add_argument(
        '-o', '--output',
        default='reports',
        help='Output directory for reports'
    )
    parser.add_argument(
        '--demo',
        action='store_true',
        help='Run with sample data'
    )
    parser.add_argument(
        '-v', '--verbose',
        action='store_true',
        help='Enable verbose output'
    )

    args = parser.parse_args()

    if args.verbose:
        logging.getLogger().setLevel(logging.DEBUG)

    print("\n" + "=" * 60)
    print("VULNERABILITY COMPARISON")
    print("=" * 60 + "\n")

    if args.demo:
        print("Generating sample data for demonstration...")
        baseline_file, current_file = generate_sample_data()
    else:
        if not args.baseline or not args.current:
            parser.error("Both --baseline and --current are required (or use --demo)")
        baseline_file = args.baseline
        current_file = args.current

    # Parse scans
    parser_obj = VulnerabilityScanParser()

    print(f"Loading baseline scan: {baseline_file}")
    baseline = parser_obj.parse_file(baseline_file)
    print(f"  Found {len(baseline.vulnerabilities)} vulnerabilities")

    print(f"Loading current scan: {current_file}")
    current = parser_obj.parse_file(current_file)
    print(f"  Found {len(current.vulnerabilities)} vulnerabilities")

    # Compare
    comparator = VulnerabilityComparator()
    result = comparator.compare(baseline, current)

    # Generate reports
    reporter = ComparisonReportGenerator(args.output)
    reports = reporter.generate_report(result)

    # Print summary
    print("\n" + "=" * 60)
    print("COMPARISON RESULTS")
    print("=" * 60)
    print(f"\nBaseline: {result.baseline_total} vulnerabilities")
    print(f"Current:  {result.current_total} vulnerabilities")
    print(f"Change:   {result.improvement_percentage:+.1f}%")
    print(f"\nNew vulnerabilities:      {result.new_count}")
    print(f"Resolved vulnerabilities: {result.resolved_count}")
    print(f"\nRisk Score: {result.risk_score_baseline:.1f} -> {result.risk_score_current:.1f} ({result.risk_reduction:+.1f})")

    print(f"\nReports generated:")
    for report_type, path in reports.items():
        print(f"  {report_type}: {path}")


if __name__ == "__main__":
    main()
